<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="./animate.css">

    <style>
        .container {
            top: 0px;
            left: 0px;
            position: fixed;
            /* background: red; */
        }

        .nav {
            background-image: url('./img/head-bg.jpg');
            background-size: 100% 100%;
            margin-top: -1%;
        }

        .lucky-box {
            position: absolute;
            bottom: 3%;

            border-radius: 8px;
        }

        .rule {
            /* background: green; */
            width: 100%;
            height: 20%;
            position: relative;
            top: 3.35%;
            display: flex;
            align-items: flex-start;
            justify-content: space-around;
        }

        .btn-title {

            color: #fae98e;
            text-decoration: underline;
            text-align: center;
        }



        .show img {
            width: 64%;
            height: 50%;
            margin-top: 10px;
        }

        .title {
            color: balck;
            font-size: 14px;
            width: 70%;
            text-align: left;
            font-weight: bold;
        }

        .little-title {
            color: red;
            font-size: 12px;
            text-align: left;
            width: 70%;
            margin-top: -10px;
        }

        .head img {
            width: 100%;
            height: 9.4%;
        }

        .value {
            position: absolute;
            top: 8%;
            font-size: 14px;
            color: #cd4f39;
            font-weight: bolder;
        }

        .box4 {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .lucky-chance {

            text-align: center;
            color: white;
            font-size: 14px;
            position: relative;
            top: 29%;
            width: 100%;

        }

        .to-rule img,
        .to-mine img {
            width: 82.5px;
            height: 28.5px;
        }

        .chance-num {
            transform: translateY(12%);
            width: 4.5%;

        }

        .rule-detail {
            width: 100%;
            position: absolute;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 10;
        }

        .close {
            width: 10%;
            z-index: 11;
            bottom: 18%;
            left: 45%;
            position: absolute;
        }

        .none {
            display: none;
        }

        .true-card {
            background: white;
        }

        .true-card img {
            width: 64%;
            height: 50%;

            margin-left: 16px;
            margin-top: 12px;
            display: block;
        }

        .true-card .value {
            width: 100%;
            margin-top: 5px;
            text-align: center;
            font-size: 14px;
            color: #cd4f39;
            font-weight: bolder;
        }

        .true-card .title {
            font-size: 14px;
            width: 70%;
            margin-left: 16px;
            margin-top: 7px;
            text-align: left;
        }

        .true-card .little-title {
            color: red;
            font-size: 12px;
            text-align: left;
            width: 70%;
            margin-left: 16px;
            margin-top: 4px;
        }

        .show4 .img-first {
            margin-top: 21px;
        }

        /* 弹出框 */

        .show-bonus {
            position: absolute;
            z-index: 51;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            /* display: flex;
            align-items:center;
            justify-content: center; */
        }

        .show-bonus .bg {

            width: 100%;
            height: 100%;
            opacity: 0.5;
            background: black;
        }

        .show-bonus .bonus-head {
            z-index: 52;
            position: absolute;
            top: 25%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 220px;
            height: 95px;
        }

        .show-box {
            position: absolute;
            top: 53%;
            left: 50%;
            z-index: 53;
            transform: translate(-50%, -50%);
            width: 236px;
            overflow-y: auto;
            overflow-x: hidden;
            height: 278px;
            background: #f5eed5;
            padding-left: 10%;
            border-radius: 10px;
        }

        .show-bonus-content {
            position: absolute;
            top: 46%;
            left: 50%;
            z-index: 53;
            transform: translate(-50%, -50%);
            width: 236px;
            overflow-y: auto;
            overflow-x: hidden;
            height: 150px;

            border-radius: 10px;
        }

        .bonus-button {
            z-index: 52;
            position: absolute;
            top: 87%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 174px;
            height: 40px;
        }

        .bonus-item {
            width: 100%;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 5px;
            background: #EC4E35;
            color: white;
        }

        .close-other {
            z-index: 52;
            position: absolute;
            top: 83%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
        }
    </style>

</head>

<body>

    <div class="container">

        <img class="rule-detail none" src="./img/rule-detail.png" alt="">

        <img class="close none" src="./img/close.png" alt="">
        <div class="head">
            <img src="./img/head.png" alt="">
        </div>
        <div class="nav">
            <div class="rule">
                <div class="to-rule">
                    <img src="./img/rule01.png" alt="">
                </div>
                <div style="width:44%;background: yellow;"></div>
                <div class="to-mine">
                    <a href="./xu.html" id="link">
                        <img src="./img/rule02.png" alt="">
                    </a>
                </div>
            </div>
            <!-- <div class="lucky-chance">您拥有2次抽奖机会</div> -->
        </div>
        <div class="lucky-box"></div>
        <div class="show-bonus none">
            <div class='bg'></div>
            <img src="./img/show-bonus.png" class="bonus-head" alt="">
            <div class="show-box">

                <div style="color:#EC4E35;margin:18px 50px;width:100px;letter-spacing: 1px;">恭喜您获得</div>
                <div class="show-bonus-content">

                    <!-- 放获得的奖品 -->

                </div>
                <a href="./xu.html">
                    <img src="./img/view.png" class="bonus-button" alt="">
                </a>
            </div>
            <img src="./img/close.png" class="close-other" alt="">
        </div>
    </div>
    <script src="./jquery.js"></script>
    <script>
        $(document).ready(function () {
            let chance_num, s, ss, total_height = 420, initFlag = false, messageArr = [],//存信息的九牌数组
                lianxu,//控制翻牌数
                can = false,//控制翻牌时机
                alert_arr =[],//弹出框数组
                bottom = '3%',//适配iPhoneX,不考虑iPhone5
                obj, time_num;//总的连续翻牌次数;
            //判断系统
            var u = navigator.userAgent;

            console.log(u);
            var isIOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端,转为boolean
            if (isIOS) {
                if (screen.height == 812 && screen.width == 375) {
                    //是iphoneX
                    // alert("垃圾iponeX!");
                    initFlag = true;
                    bottom = "10%";

                } else {
                    //不是iphoneX

                }
            }

            function luckyDraw(obj, time, timeout) {
                s = null, ss = null, can = false;
                let flag = false;


                let initData = [{ top: 0.0143 * obj.total_height, left: 0.0188 * obj.total_width }, { top: 0.0143 * obj.total_height, left: 0.341 * obj.total_width }, { top: 0.0143 * obj.total_height, left: 0.664 * obj.total_width }, { top: 0.340 * obj.total_height, left: 0.0188 * obj.total_width }, { top: 0.340 * obj.total_height, left: 0.341 * obj.total_width }, { top: 0.340 * obj.total_height, left: 0.664 * obj.total_width }, { top: 0.665 * obj.total_height, left: 0.0188 * obj.total_width }, { top: 0.665 * obj.total_height, left: 0.341 * obj.total_width }, { top: 0.665 * obj.total_height, left: 0.664 * obj.total_width }]


                for (let i = 0; i < 9; i++) {
                    let content = `<img src="./img/cards.png" alt="">`,
                        z_index = 4,
                        box_bg = `<img class="box-bg box-bg` + i + `" src="./img/box-bg1.png" alt="">`
                    if (i == 4) {
                        z_index = 3;
                        content = `<img class="img-first false" src="./img/btn-none.png" alt="">`;
                        box_bg = `<div class="img-first box-bg "></div>`
                    }
                    $(`<div class="box box` + i + `"></div>`).appendTo($('.lucky-box')).css({
                        'width': obj.total_width * 0.313,
                        'height': obj.total_height * 0.318,
                        'position': 'absolute',

                        'z-index': z_index
                    }).html(content);
                    $(box_bg).appendTo($('.lucky-box')).css({
                        'width': obj.total_width * 0.313,
                        'height': obj.total_height * 0.318,
                        'position': 'absolute',

                    });
                    $('.box img').css({
                        'width': obj.total_width * 0.313,
                        'height': obj.total_height * 0.318,
                    });


                    $('.img-first').css({
                        'width': obj.total_width * 0.313 * 0.845,
                        'height': obj.total_height * 0.318 * 0.635,
                    });
                    $('.box').eq(i).css({
                        'top': initData[i].top,
                        'left': initData[i].left
                    });
                    console.log($('.box-bg').eq(i));
                    $('.box-bg').eq(i).css({
                        'top': initData[i].top,
                        'left': initData[i].left
                    });

                }
                function repeat(type) {
                    let count_sort = [0, 1, 2, 5, 8, 7, 6, 3], count = 0, top, left, s = null;
                    s = setInterval(function () {
                        if (type === 'in') {
                            top = initData[4].top;
                            left = initData[4].left;
                        } else if (type === 'out') {
                            top = initData[count_sort[count]].top;
                            left = initData[count_sort[count]].left;
                            // clearTimeout(ss);
                            flag = true;
                        }
                        $('.box').eq(count_sort[count]).animate({
                            top: top,
                            left: left
                        });
                        count++;

                        if (type == 'out' && count == 8) {
                            can = true;
                        }
                        // console.log();
                        if (count == 8) {
                            // can = true;
                            if (type == "out") {

                                clearInterval(s);
                            }

                            ss = setTimeout(function () {
                                repeat('out');
                                console.log(count);


                            }, timeout);

                        }
                    }, time - (count / 2) * 60);
                }
                repeat('in');
                lianxu = 0;
                let haiceshi = $('.box4').find('img').attr('class');
                console.log(haiceshi);
                console.log(haiceshi.indexOf('false'));
                if (haiceshi.indexOf('false') == -1) {

                }
                // console.log(can)

                $('.box').on('click', {}, function () {
                    if (!can) {
                        return;
                    }
                    clearInterval(s);
                    clearTimeout(ss);
                    if ($(this).attr('class').indexOf('box4') == -1 && chance_num > 0) {
                        console.log("连续：", time_num);
                        console.log("极限：", lianxu);
                        if (lianxu >= time_num) {
                            alert('单次抽奖翻牌数已到上限，请重新抽奖！');
                            return;
                        }

                        $(this).html('');
                        send(138701, 2, $(this));
                        if (lianxu == time_num - 1) {

                            $('.box4').html(`<img class="img-first true" src="./img/btn.png" alt="">`).find('img').css({
                                'width': obj.total_width * 0.313 * 0.845,
                                'height': obj.total_height * 0.318 * 0.635,
                            });
                        }
                        $(this).find('img').css({
                            'width': '64%',
                            'height': '50%',
                        });

                        lianxu++;
                        if (lianxu == time_num) {
                            chance_num--;


                            if (chance_num == 0) {
                                $('.box4').html(`<img class="img-first again" src="./img/again.gif" alt="">`).find('img').css({
                                    'width': obj.total_width * 0.313 * 0.845,
                                    'height': obj.total_height * 0.318 * 0.635,
                                });
                                let lucky_chance = `<div class="lucky-chance" style="padding-top:0%;">您拥有<img class="chance-num" src="./img/` + (chance_num) + `.png" alt="">次翻牌机会</div>`
                                $('.lucky-chance').html($(lucky_chance));
                                $('.box .again').on('click', {}, function () {
                                    $('.rule-detail').removeClass('none');
                                    $('.close').removeClass('none');

                                    $('.close').on('click', {}, function () {
                                        $('.rule-detail').addClass('none');
                                        $('.close').addClass('none');
                                    });
                                });
                                $('.show-bonus').removeClass('none');
                                
                                // alert_arr.push('xuruoahi')
                                let bonus_item='';
                               let ooo=setTimeout(function(){
                                console.log(alert_arr.length);
                                for (let i = 0; i < alert_arr.length; i++) {

                                    bonus_item += `<div class="bonus-item">` + alert_arr[i] + `</div>`;
                                }
                                $('.show-bonus-content').append(bonus_item);
                               },500); 
                                return;
                            } else {
                                let lucky_chance = `<div class="lucky-chance">您拥有<img class="chance-num" src="./img/` + (chance_num) + `.png" alt="">次翻牌机会</div>`
                                $('.lucky-chance').html($(lucky_chance));
                                return;
                            }
                        }
                        innerFlag = true;
                    } else if (chance_num > 0) {
                        if (ss) {

                            clearTimeout(ss);
                        }
                        if ($('.img-first').attr('class').indexOf('true') != -1) {
                            $('.lucky-box').html('');
                            luckyDraw(obj, 150, 1000);

                        } else {
                            alert('开始翻牌抽奖吧！');
                        }
                    } else {

                        $('.box .again').on('click', {}, function () {
                            $('.rule-detail').removeClass('none');
                            $('.close').removeClass('none');

                            $('.close').on('click', {}, function () {
                                $('.rule-detail').addClass('none');
                                $('.close').addClass('none');
                            });
                        });

                    }

                });



            }
            console.log($(document).height());
            console.log($(document).width());



            function show(data) {

                console.log("数据:", data)
                let data_infoList = data.lucky_draw_prize_info.prize_list;
                let bk_img = '100% 100%';

                $('.container').css({
                    'width': $(document).width(),
                    'height': $(document).height(),
                    'background-image': "url('./img/bg.png')",
                    'background-size': bk_img,


                });
                $('.nav').css({
                    'width': $(document).width(),
                    'height': $(document).height() * 0.317,

                });
                let initData = [{ top: 0.0143 * obj.total_height, left: 0.0188 * obj.total_width }, { top: 0.0143 * obj.total_height, left: 0.341 * obj.total_width }, { top: 0.0143 * obj.total_height, left: 0.664 * obj.total_width }, { top: 0.340 * obj.total_height, left: 0.0188 * obj.total_width }, { top: 0.340 * obj.total_height, left: 0.341 * obj.total_width }, { top: 0.340 * obj.total_height, left: 0.664 * obj.total_width }, { top: 0.665 * obj.total_height, left: 0.0188 * obj.total_width }, { top: 0.665 * obj.total_height, left: 0.341 * obj.total_width }, { top: 0.665 * obj.total_height, left: 0.664 * obj.total_width }]
                // let small = 0, mid = 210, big = 420;
                console.log(chance_num);
                let lucky_chance = `<div class="lucky-chance">您拥有<img class="chance-num" src="./img/` + (chance_num) + `.png" alt="">次翻牌机会</div>`
                $(lucky_chance).appendTo($('.nav'));
                $('.rule img').css({
                    'width': $(document).width() * 0.22,
                    // 'height': $(document).height() * 0.06,
                });
                for (let i = 0; i < 9; i++) {
                    console.log('当前位置：', i);

                    let detail, bk, price = (i < 4 && data_infoList[i].prize_type != 1) ? data_infoList[i].price + '元' : '';

                    if (i < 4) {
                        detail = `<img class="` + data_infoList[i].id + `" src="` + data_infoList[i].cover + `" alt="">
                        <div class="value">`+ price + `</div>
                  <div class="title">`+ data_infoList[i].name + `</div>
                  <div class="little-title">`+ data_infoList[i].nickname + `</div>
                  `, bk = "white";
                    }
                    else if (i == 4) {

                        detail = `<img class="img-first btn" src="./img/btn.png" alt="">`;
                        if (chance_num == 0) {
                            detail = `<img class="img-first again" src="./img/again.gif" alt="">`;
                        }
                        bk = "";
                    } else {
                        price = (data_infoList[i-1].prize_type != 1)?data_infoList[i - 1].price + '元':'';
                        let name = data_infoList[i - 1].name, nickname = data_infoList[i - 1].nickname;
                        detail = `<img class="` + data_infoList[i - 1].id + `" src="` + data_infoList[i - 1].cover + `" alt="">
                        <div class="value">`+ price + `</div>
                        <div class="title">`+ name + `</div>
                        <div class="little-title">`+ nickname + `</div>
                  `, bk = "white";
                    }
                    let content = `<img src="./img/cards.png" alt="">`;

                    $(`<div class="show show` + i + `" style="width:31.3%;height:31.8%;position:absolute;display:flex;justify-content:center;
                    flex-wrap:wrap;z-index:2;"></div>`).appendTo($('.lucky-box')).css({

                            'background': bk,

                        }).html(detail);
                    $('.img-first').css({
                        'width': obj.total_width * 0.313 * 0.845,
                        'height': obj.total_height * 0.318 * 0.635,
                    });
                    let num = parseInt(i / 3);
                    $('.show').eq(i).css({
                        'top': initData[i].top,
                        'left': initData[i].left
                    });
                    console.log('看下九条数据');
                    let liji = '.show' + i;
                    // console.log($(liji).html());
                    if (i != 4) {
                        messageArr.push($(liji).html());
                    }
                }
                console.log(messageArr);
                $('.show .btn').on('click', {}, function () {
                    if (chance_num <= 0) {
                        alert('没机会不能翻牌额~');
                        return;
                    }
                    console.log(this);
                    $('.lucky-box').html('');
                    luckyDraw(obj, 150, 1000);


                });
                $('.show .again').on('click', {}, function () {

                    $('.rule-detail').removeClass('none');
                    $('.close').removeClass('none');

                    $('.close').on('click', {}, function () {
                        $('.rule-detail').addClass('none');
                        $('.close').addClass('none');
                    });
                });
            }
            $('#link').on('click', {}, function (e) {
                if (lianxu < time_num) {
                    alert('请继续抽奖额~');
                    e.preventDefault();
                    return;
                }

            })

            $('.to-rule').on('click', {}, function () {
                if (lianxu < time_num) {
                    alert('请继续抽奖额~');
                    return;
                }
                $('.rule-detail').removeClass('none');
                $('.close').removeClass('none');

                $('.close').on('click', {}, function () {
                    $('.rule-detail').addClass('none');
                    $('.close').addClass('none');
                });
            });
            //点击关闭弹出框
            $('.close-other').on('click', {}, function () {

                $('.show-bonus').addClass('none');

            });
            //点击按钮跳转全部产品

            function isIPhoneX(li) {
                var u = navigator.userAgent;
                console.log(u);
                var isIOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端,转为boolean
                if (isIOS) {
                    if (screen.height == 812 && screen.width == 375) {
                        //是iphoneX
                        // alert("垃圾iponeX!");
                        li = true;
                    } else {
                        //不是iphoneX
                        li = false;
                    }
                }
            }
            function getData() {
                $.ajax({
                    url: 'http://wds.yfway.com/wds-test/index.php?s=/Home/Api/action',
                    type: 'get',
                    dataType: 'jsonp',

                    jsonpCallback: 'successCallback',
                    data: {
                        func: 'get-lucky-draw-info',
                        user_id: 138701,
                        lucky_draw_id: 2
                    },
                    success: function (res) {
                        console.log("成功");
                        console.log(res);
                        if (res.status == 2) {
                            alert('抽奖活动已经结束了额');
                            return;
                        }
                        //关键的obj,就是lucky-box的大小,目前是死的
                        obj = { total_width: 320, total_height: total_height };
                        let initTop = '34.6%';
                        //控制机会次数

                        // chance_num = res.lucky_draw_prize_info.user_lucky_draw_info.times;
                        chance_num=2;
                        time_num = res.lucky_draw_prize_info.user_lucky_draw_info.number;//控制连续翻牌次数
                        if (initFlag) {
                            //是iphoneX
                            // alert("垃圾iponeX!");
                            initTop = '37.6%';
                        }
                        $('.lucky-box').css({
                            'width': 320,
                            'height': total_height,
                            'background-image': "url('./img/lucky-bg.png')",
                            'background-size': '100% 100%',
                            'bottom': bottom,
                            'left': ($(document).width() - obj.total_width) / 2
                        });
                        show(res);
                    },

                })
            }
            //发送数据；、
            function send(uid, id, obj) {
                $.ajax({
                    url: 'http://wds.yfway.com/wds-test/index.php?s=/Home/Api/action',
                    type: 'get',
                    dataType: 'jsonp',

                    jsonpCallback: 'successCallback',
                    data: {
                        func: 'get-lucky-prize',
                        user_id: uid,
                        lucky_draw_id: id
                    },
                    success: function (res) {
                        console.log(res.message[0]);
                        if (res.message[0].prize_type == 1) {
                            obj.html(`<img  src="` + res.message[0].cover + `" alt="">
                            
                            <div class="title" style="margin-top:0px;">`+ res.message[0].name + `</div>
                            <div class="little-title" style="margin-top:1px;">`+ res.message[0].nickname + `</div>`);
                            alert_arr.push(res.message[0].name);
                        } else {
                            obj.html(`<img  src="` + res.message[0].cover + `" alt="">
                            <div class="value">`+ res.message[0].price + `元</div>
                            <div class="title">`+ res.message[0].name + `</div>
                            <div class="little-title">`+ res.message[0].nickname + `</div>`);
                            alert_arr.push(res.message[0].name);
                        }
                        console.log(alert_arr);
                        obj.addClass('animated flipOutY');
                        obj.removeClass('flipOutY').addClass('flipInY true-card')
                    },

                })
            }

            getData();
        });


    </script>

</body>

</html>